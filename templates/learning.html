<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Manager | Scribe</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --success: #22c55e;
            --bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            color: var(--text-main);
            margin: 0;
            padding: 40px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        h1 {
            font-weight: 800;
            margin: 0;
            color: var(--text-main);
        }

        .home-btn {
            text-decoration: none;
            color: var(--primary);
            font-weight: 600;
            border: 1px solid var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: var(--primary);
            color: white;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .sync-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
            background: #16a34a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            color: var(--text-sub);
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        td {
            font-weight: 500;
        }

        .badge {
            background: #e0e7ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        #status-msg {
            margin-right: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* DASHBOARD STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-sub);
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* ADAPTIVE TUTOR */
        .tutor-section {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .tutor-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0xMiAyNEwxMiAwTDI0IDEyTDEyIDI0WiIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuMDUiLz48L3N2Zz4=');
            opacity: 0.2;
        }

        .flashcard {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px;
            margin: 20px auto;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .word-display {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .practice-btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 12px 30px;
            border-radius: 99px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .practice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .practice-btn:disabled {
            opacity: 0.7;
            transform: none;
        }

        #feedback-msg {
            margin-top: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            min-height: 27px;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Vocabulary Manager</h1>
            <a href="/" class="home-btn">‚Üê Home</a>
        </header>

        <!-- DASHBOARD STATS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Learned Words</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-mastery">0%</div>
                <div class="stat-label">Mastery Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-pending">0</div>
                <div class="stat-label">Pending Validation</div>
            </div>
        </div>

        <!-- ADAPTIVE TUTOR -->
        <div class="tutor-section">
            <h2 style="margin:0;">Adaptive Tutor üéì</h2>
            <p style="opacity:0.9;">Practice your pronunciation to increase mastery.</p>

            <div class="flashcard">
                <div class="word-display" id="tutor-word">...</div>
                <button class="practice-btn" id="practice-btn" onclick="togglePractice()">
                    üé§ Start
                </button>
                <div id="feedback-msg">Press Start to practice</div>
            </div>
            <button onclick="nextWord()"
                style="background:transparent; border:1px solid rgba(255,255,255,0.4); color:white; padding:8px 16px; border-radius:8px; cursor:pointer;">Skip
                / Next</button>
        </div>

        <div class="card">
            <div class="actions">
                <span id="status-msg"></span>
                <button class="sync-btn" onclick="syncWords()">
                    üîÑ Sync & Validate
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Word</th>
                        <th>Frequency</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody id="word-list">
                    <tr>
                        <td colspan="4" style="text-align:center; color:var(--text-sub);">Loading words...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let learnedWords = [];
        let currentWord = null;
        let isPracticing = false;
        let practiceInterval = null;

        async function loadData() {
            // Load Words
            try {
                let res = await fetch("/get_learned_words");
                learnedWords = await res.json();
                renderTable(learnedWords);
                updateStats(learnedWords);
                if (!currentWord && learnedWords.length > 0) nextWord();
            } catch (e) { console.error(e); }
        }

        function renderTable(data) {
            let tbody = document.getElementById("word-list");
            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:30px;'>No learned words yet.</td></tr>";
                return;
            }
            tbody.innerHTML = data.map(w => `
                <tr>
                    <td style="color:#94a3b8;">#${w.id}</td>
                    <td style="font-size:1.1rem;">${w.word}</td>
                    <td>${w.count}</td>
                    <td><span class="badge">${w.category || 'General'}</span></td>
                </tr>
            `).join("");
        }

        function updateStats(data) {
            document.getElementById("stat-total").innerText = data.length;

            // Calculate pseudo-mastery
            let totalFreq = data.reduce((acc, w) => acc + w.count, 0);
            let mastery = data.length > 0 ? Math.min(100, Math.round((totalFreq / (data.length * 5)) * 100)) : 0;
            document.getElementById("stat-mastery").innerText = mastery + "%";

            // Get pending count
            fetch("/unknown_words").then(r => r.json()).then(d => {
                document.getElementById("stat-pending").innerText = d.filter(x => x.status === 'new').length;
            });
        }

        // --- TUTOR LOGIC ---
        function nextWord() {
            if (learnedWords.length === 0) return;
            // Adaptive: Pick word with lowest count
            let candidates = [...learnedWords].sort((a, b) => a.count - b.count);
            // Pick random from top 3 to avoid repetition
            let idx = Math.floor(Math.random() * Math.min(3, candidates.length));
            currentWord = candidates[idx];

            document.getElementById("tutor-word").innerText = currentWord.word;
            document.getElementById("feedback-msg").innerText = "Say the word clearly!";
            document.getElementById("feedback-msg").style.color = "white";
        }

        async function togglePractice() {
            const btn = document.getElementById("practice-btn");
            const msg = document.getElementById("feedback-msg");

            if (!isPracticing) {
                // Start
                try {
                    await fetch("/record/start", { method: "POST", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ lang: "auto" }) });
                    isPracticing = true;
                    btn.innerText = "Listening...";
                    btn.style.animation = "pulse 1.5s infinite";
                    msg.innerText = "Listening...";

                    // Poll for result
                    let attempts = 0;
                    practiceInterval = setInterval(async () => {
                        attempts++;
                        let res = await fetch("/data?limit=1");
                        let data = await res.json();
                        if (data.length > 0) {
                            let lastText = data[0].text.toLowerCase();
                            // Simple substring match
                            if (lastText.includes(currentWord.word.toLowerCase())) {
                                // Success!
                                finishPractice(true);
                            }
                        }
                        if (attempts > 20) finishPractice(false); // Timeout after ~10s
                    }, 500);

                } catch (e) { console.error(e); }
            } else {
                finishPractice(false);
            }
        }

        async function finishPractice(success) {
            clearInterval(practiceInterval);
            isPracticing = false;
            await fetch("/record/stop", { method: "POST" });

            const btn = document.getElementById("practice-btn");
            const msg = document.getElementById("feedback-msg");
            btn.style.animation = "none";
            btn.innerText = "üé§ Start";

            if (success) {
                msg.innerText = "üéâ Excellent! Correct.";
                // Celebrate UI
                document.querySelector(".tutor-section").style.background = "linear-gradient(135deg, #22c55e 0%, #16a34a 100%)";
                setTimeout(() => {
                    document.querySelector(".tutor-section").style.background = ""; // Reset
                    nextWord();
                    loadData(); // Refresh (freq should bump)
                }, 2000);
            } else {
                msg.innerText = "‚ùå Try again.";
            }
        }

        async function syncWords() {
            // ... (keep existing sync logic) ...
            const btn = document.querySelector(".sync-btn");
            const status = document.getElementById("status-msg");

            btn.disabled = true;
            btn.style.opacity = "0.7";
            status.innerText = "Validating online...";
            status.style.color = "var(--text-sub)";

            try {
                // Call the existing or new validation endpoint
                let res = await fetch("/validate_now");
                let data = await res.json();

                if (data.status === "success") {
                    status.innerText = `‚úÖ Validated ${data.validated_count} new words!`;
                    status.style.color = "var(--success)";
                    loadData(); // Refresh table
                } else {
                    status.innerText = "‚ö†Ô∏è Validation incomplete.";
                    status.style.color = "#eab308";
                }
            } catch (e) {
                status.innerText = "‚ùå Validation Failed";
                status.style.color = "#ef4444";
            }

            setTimeout(() => {
                btn.disabled = false;
                btn.style.opacity = "1";
            }, 2000);
        }

        // Initial Load
        loadData();
    </script>
</body>

</html>